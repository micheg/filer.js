'use strict';var self=this;self.URL=self.URL||self.webkitURL;self.requestFileSystem=self.requestFileSystem||self.webkitRequestFileSystem;self.resolveLocalFileSystemURL=self.resolveLocalFileSystemURL||self.webkitResolveLocalFileSystemURL;self.storageInfo=self.storageInfo||self.webkitStorageInfo;self.BlobBuilder=self.BlobBuilder||self.MozBlobBuilder||self.WebKitBlobBuilder;if(self.FileError===undefined){var FileError=function(){};FileError.prototype.prototype=Error.prototype;}
var Util={toArray:function(list){return Array.prototype.slice.call(list||[],0);},strToDataURL:function(str,contentType,opt_isBinary){var isBinary=opt_isBinary!=undefined?opt_isBinary:true;if(isBinary){return'data:'+contentType+';base64,'+self.btoa(str);}else{return'data:'+contentType+','+str;}},strToObjectURL:function(binStr,opt_contentType){var ui8a=new Uint8Array(binStr.length);for(var i=0;i<ui8a.length;++i){ui8a[i]=binStr.charCodeAt(i);}
var blob=new Blob([ui8a],opt_contentType?{type:opt_contentType}:{});return self.URL.createObjectURL(blob);},fileToObjectURL:function(blob){return self.URL.createObjectURL(blob);},fileToArrayBuffer:function(blob,callback,opt_errorCallback){var reader=new FileReader();reader.onload=function(e){callback(e.target.result);};reader.onerror=function(e){if(opt_errorCallback){opt_errorCallback(e);}};reader.readAsArrayBuffer(blob);},dataURLToBlob:function(dataURL){var BASE64_MARKER=';base64,';if(dataURL.indexOf(BASE64_MARKER)==-1){var parts=dataURL.split(',');var contentType=parts[0].split(':')[1];var raw=parts[1];return new Blob([raw],{type:contentType});}
var parts=dataURL.split(BASE64_MARKER);var contentType=parts[0].split(':')[1];var raw=window.atob(parts[1]);var rawLength=raw.length;var uInt8Array=new Uint8Array(rawLength);for(var i=0;i<rawLength;++i){uInt8Array[i]=raw.charCodeAt(i);}
return new Blob([uInt8Array],{type:contentType});},arrayBufferToBlob:function(buffer,opt_contentType){var uInt8Array=new Uint8Array(buffer);return new Blob([uInt8Array],opt_contentType?{type:opt_contentType}:{});},arrayBufferToBinaryString:function(buffer,callback,opt_errorCallback){var reader=new FileReader();reader.onload=function(e){callback(e.target.result);};reader.onerror=function(e){if(opt_errorCallback){opt_errorCallback(e);}};var uInt8Array=new Uint8Array(buffer);reader.readAsBinaryString(new Blob([uInt8Array]));},arrayToBinaryString:function(bytes){if(typeof bytes!=typeof[]){return null;}
var i=bytes.length;var bstr=new Array(i);while(i--){bstr[i]=String.fromCharCode(bytes[i]);}
return bstr.join('');},getFileExtension:function(filename){var idx=filename.lastIndexOf('.');return idx!=-1?filename.substring(idx):'';}};var MyFileError=function(obj){this.prototype=FileError.prototype;this.code=obj.code;this.name=obj.name;};FileError.BROWSER_NOT_SUPPORTED=1000;FileError.prototype.__defineGetter__('name',function(){var keys=Object.keys(FileError);for(var i=0,key;key=keys[i];++i){if(FileError[key]==this.code){return key;}}
return'Unknown Error';});var Filer=new function(){var FS_INIT_ERROR_MSG='Filesystem has not been initialized.';var NOT_IMPLEMENTED_MSG='Not implemented.';var NOT_A_DIRECTORY='Path was not a directory.';var INCORRECT_ARGS='These method arguments are not supported.';var FS_URL_SCHEME='filesystem:';var DEFAULT_FS_SIZE=1024*1024;var fs_=null;var cwd_=null;var isOpen_=false;var isFsURL_=function(path){return path.indexOf(FS_URL_SCHEME)==0;};var pathToFsURL_=function(path){if(!isFsURL_(path)){if(path[0]=='/'){path=fs_.root.toURL()+path.substring(1);}else if(path.indexOf('./')==0||path.indexOf('../')==0){if(path=='../'&&cwd_!=fs_.root){path=cwd_.toURL()+'/'+path;}else{path=cwd_.toURL()+path;}}else{path=cwd_.toURL()+'/'+path;}}
return path;};var getEntry_=function(callback,var_args){var srcStr=arguments[1];var destStr=arguments[2];var opt_cb=(arguments[3])?(arguments[3]):null;var onError=function(e){if(opt_cb)opt_cb(e);else
{if(e.code==FileError.NOT_FOUND_ERR){if(destStr){throw new Error('"'+srcStr+'" or "'+destStr+'" does not exist.');}else{throw new Error('"'+srcStr+'" does not exist.');}}else{throw new Error('Problem getting Entry for one or more paths.');}}};var src=pathToFsURL_(srcStr);if(arguments.length==3){var dest=pathToFsURL_(destStr);self.resolveLocalFileSystemURL(src,function(srcEntry){self.resolveLocalFileSystemURL(dest,function(destEntry){callback(srcEntry,destEntry);},onError);},onError);}else{self.resolveLocalFileSystemURL(src,callback,onError);}};var copyOrMove_=function(src,dest,opt_newName,opt_successCallback,opt_errorHandler,opt_deleteOrig){var self=this;if(!fs_){throw new Error(FS_INIT_ERROR_MSG);}
if(typeof src!=typeof dest){throw new Error(INCORRECT_ARGS);}
var newName=opt_newName||null;var deleteOrig=opt_deleteOrig!=undefined?opt_deleteOrig:false;if((src.isFile||dest.isDirectory)&&dest.isDirectory){if(deleteOrig){src.moveTo(dest,newName,opt_successCallback,opt_errorHandler);}else{src.copyTo(dest,newName,opt_successCallback,opt_errorHandler);}}else{getEntry_(function(srcEntry,destDir){if(!destDir.isDirectory){var e=new Error('Oops! "'+destDir.name+' is not a directory!');if(opt_errorHandler){opt_errorHandler(e);}else{throw e;}
return;}
if(deleteOrig){srcEntry.moveTo(destDir,newName,opt_successCallback,opt_errorHandler);}else{srcEntry.copyTo(destDir,newName,opt_successCallback,opt_errorHandler);}},src,dest);}}
function Filer(fs){fs_=fs||null;if(fs_){cwd_=fs_.root;isOpen_=true;}}
Filer.DEFAULT_FS_SIZE=DEFAULT_FS_SIZE;Filer.version='0.4';Filer.prototype={get fs(){return fs_;},get isOpen(){return isOpen_;},get cwd(){return cwd_;}}
Filer.prototype.pathToFilesystemURL=function(path){return pathToFsURL_(path);}
Filer.prototype.init=function(opt_initObj,opt_successCallback,opt_errorHandler){if(!self.requestFileSystem){throw new MyFileError({code:FileError.BROWSER_NOT_SUPPORTED,name:'BROWSER_NOT_SUPPORTED'});}
var initObj=opt_initObj?opt_initObj:{};var size=initObj.size||DEFAULT_FS_SIZE;this.type=self.TEMPORARY;if('persistent'in initObj&&initObj.persistent){this.type=self.PERSISTENT;}
var init=function(fs){this.size=size;fs_=fs;cwd_=fs_.root;isOpen_=true;opt_successCallback&&opt_successCallback(fs);};if(this.type==self.PERSISTENT&&!!self.storageInfo){self.storageInfo.requestQuota(this.type,size,function(grantedBytes){self.requestFileSystem(this.type,grantedBytes,init.bind(this),opt_errorHandler);}.bind(this),opt_errorHandler);}else{self.requestFileSystem(this.type,size,init.bind(this),opt_errorHandler);}};Filer.prototype.ls=function(dirEntryOrPath,successCallback,opt_errorHandler){if(!fs_){throw new Error(FS_INIT_ERROR_MSG);}
var callback=function(dirEntry){cwd_=dirEntry;var entries_=[];var reader=cwd_.createReader();var readEntries=function(){reader.readEntries(function(results){if(!results.length){entries_.sort(function(a,b){return a.name<b.name?-1:b.name<a.name?1:0;});successCallback(entries_);}else{entries_=entries_.concat(Util.toArray(results));readEntries();}},opt_errorHandler);};readEntries();};if(dirEntryOrPath.isDirectory){callback(dirEntryOrPath);}else if(isFsURL_(dirEntryOrPath)){getEntry_(callback,pathToFsURL_(dirEntryOrPath));}else{cwd_.getDirectory(dirEntryOrPath,{},callback,opt_errorHandler);}};Filer.prototype.mkdir=function(path,opt_exclusive,successCallback,opt_errorHandler){if(!fs_){throw new Error(FS_INIT_ERROR_MSG);}
if(path==='')
{successCallback();}
var exclusive=opt_exclusive!=null?opt_exclusive:false;var folderParts=path.split('/');var createDir=function(rootDir,folders){if(folders[0]=='.'||folders[0]==''){folders=folders.slice(1);}
rootDir.getDirectory(folders[0],{create:true,exclusive:exclusive},function(dirEntry){if(dirEntry.isDirectory){if(folders.length&&folderParts.length!=1){createDir(dirEntry,folders.slice(1));}else{successCallback(dirEntry);}}else{var e=new Error(path+' is not a directory');if(opt_errorHandler){opt_errorHandler(e);}else{throw e;}}},function(e){if(e.code==FileError.INVALID_MODIFICATION_ERR){e.message="'"+path+"' already exists";if(opt_errorHandler){opt_errorHandler(e);}else{throw e;}}});};createDir(cwd_,folderParts);};Filer.prototype.open=function(entryOrPath,successCallback,opt_errorHandler){if(!fs_){throw new Error(FS_INIT_ERROR_MSG);}
if(entryOrPath.isFile){entryOrPath.file(successCallback,opt_errorHandler);}else{getEntry_(function(fileEntry){fileEntry.file(successCallback,opt_errorHandler);},pathToFsURL_(entryOrPath),undefined,opt_errorHandler);}};Filer.prototype.create=function(path,opt_exclusive,successCallback,opt_errorHandler){if(!fs_){throw new Error(FS_INIT_ERROR_MSG);}
var exclusive=opt_exclusive!=null?opt_exclusive:true;cwd_.getFile(path,{create:true,exclusive:exclusive},successCallback,function(e){if(e.code==FileError.INVALID_MODIFICATION_ERR){e.message="'"+path+"' already exists";}
if(opt_errorHandler){opt_errorHandler(e);}else{throw e;}});};Filer.prototype.mv=function(src,dest,opt_newName,opt_successCallback,opt_errorHandler){copyOrMove_.bind(this,src,dest,opt_newName,opt_successCallback,opt_errorHandler,true)();};Filer.prototype.rm=function(entryOrPath,successCallback,opt_errorHandler){if(!fs_){throw new Error(FS_INIT_ERROR_MSG);}
var removeIt=function(entry){if(entry.isFile){entry.remove(successCallback,opt_errorHandler);}else if(entry.isDirectory){entry.removeRecursively(successCallback,opt_errorHandler);}};if(entryOrPath.isFile||entryOrPath.isDirectory){removeIt(entryOrPath);}else{getEntry_(removeIt,entryOrPath);}};Filer.prototype.cd=function(dirEntryOrPath,opt_successCallback,opt_errorHandler){if(!fs_){throw new Error(FS_INIT_ERROR_MSG);}
if(dirEntryOrPath.isDirectory){cwd_=dirEntryOrPath;opt_successCallback&&opt_successCallback(cwd_);}else{var dirEntryOrPath=pathToFsURL_(dirEntryOrPath);getEntry_(function(dirEntry){if(dirEntry.isDirectory){cwd_=dirEntry;opt_successCallback&&opt_successCallback(cwd_);}else{var e=new Error(NOT_A_DIRECTORY);if(opt_errorHandler){opt_errorHandler(e);}else{throw e;}}},dirEntryOrPath);}};Filer.prototype.cp=function(src,dest,opt_newName,opt_successCallback,opt_errorHandler){copyOrMove_.bind(this,src,dest,opt_newName,opt_successCallback,opt_errorHandler)();};Filer.prototype.write=function(entryOrPath,dataObj,successCallback,opt_errorHandler){if(!fs_){throw new Error(FS_INIT_ERROR_MSG);}
var writeFile_=function(fileEntry){fileEntry.createWriter(function(fileWriter){fileWriter.onerror=opt_errorHandler;if(dataObj.append){fileWriter.onwriteend=function(e){successCallback(fileEntry,this);};fileWriter.seek(fileWriter.length);}else{var truncated=false;fileWriter.onwriteend=function(e){if(!truncated){truncated=true;this.truncate(this.position);return;}
successCallback(fileEntry,this);};}
if(dataObj.data.__proto__==ArrayBuffer.prototype){dataObj.data=new Uint8Array(dataObj.data);}
var blob=new Blob([dataObj.data],dataObj.type?{type:dataObj.type}:{});fileWriter.write(blob);},opt_errorHandler);};if(entryOrPath.isFile){writeFile_(entryOrPath);}else if(isFsURL_(entryOrPath)){getEntry_(writeFile_,entryOrPath);}else{cwd_.getFile(entryOrPath,{create:true,exclusive:false},writeFile_,opt_errorHandler);}};Filer.prototype.download=function(remoteURL,entryOrPath,successCallback,opt_errorHandler)
{var xhr=new XMLHttpRequest();xhr.responseType='blob';xhr.open("GET",remoteURL,true);var tmp_filer=this;xhr.onload=function(e)
{if(this.status==200)
{var buff=xhr.response;tmp_filer.write(entryOrPath,{data:buff,type:buff.type},function(fileEntry,fileWriter)
{if(successCallback)
{successCallback(fileEntry);}},opt_errorHandler);}
else
{if(opt_errorHandler)
{opt_errorHandler();}}};xhr.onerror=function(e){if(opt_errorHandler)opt_errorHandler();};xhr.send();};Filer.prototype.exist=function(path,successCallback,opt_errorHandler)
{if(opt_errorHandler!==null)
{opt_errorHandler=function(){};}
fs_.root.getFile(path,{create:false},function(){successCallback();},function(){opt_errorHandler();});if(false)
{var src=pathToFsURL_(path);self.resolveLocalFileSystemURL(src,successCallback,opt_errorHandler);}};return Filer;};